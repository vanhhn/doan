generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Station {
  id              Int              @id @default(autoincrement())
  name            String           @unique @db.VarChar(100)
  location        String?          @db.VarChar(255)
  status          String           @default("inactive") @db.VarChar(50)
  totalSlots      Int              @default(6) @map("total_slots")
  availableSlots  Int              @default(6) @map("available_slots")
  lastMaintenance DateTime?        @map("last_maintenance") @db.Timestamptz(6)
  createdAt       DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  maintenanceLogs MaintenanceLog[]
  reservations    Reservation[]
  slots           Slot[]
  transactionLogs TransactionLog[]

  @@map("stations")
}

model Battery {
  uid                String             @id @db.VarChar(50)
  status             String             @default("in_stock") @db.VarChar(50)
  chargeCycles       Int                @default(0) @map("charge_cycles")
  lastCharged        DateTime?          @map("last_charged") @db.Timestamptz(6)
  createdAt          DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  customers          Customer[]
  slots              Slot[]
  transactionLogsNew TransactionLog[]   @relation("NewBattery")
  transactionLogsOld TransactionLog[]   @relation("OldBattery")
  warehouseBatteries WarehouseBattery[]

  @@map("batteries")
}

model Customer {
  id                Int              @id @default(autoincrement())
  fullName          String           @map("full_name") @db.VarChar(100)
  username          String           @unique @db.VarChar(50)
  passwordHash      String           @map("password_hash") @db.VarChar(255)
  phone             String?          @unique @db.VarChar(20)
  email             String?          @unique @db.VarChar(100)
  currentBatteryUid String?          @map("current_battery_uid") @db.VarChar(50)
  totalSwaps        Int              @default(0) @map("total_swaps")
  balance           Float            @default(0)
  avatarUrl         String?          @map("avatar_url")
  createdAt         DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  currentBattery    Battery?         @relation(fields: [currentBatteryUid], references: [uid])
  feedbacks         Feedback[]
  reservations      Reservation[]
  transactionLogs   TransactionLog[]

  @@map("customers")
}

model Slot {
  id               Int         @id @default(autoincrement())
  stationId        Int         @map("station_id")
  slotNumber       Int         @map("slot_number")
  status           String      @default("empty") @db.VarChar(50)
  isBatteryPresent Boolean     @default(false) @map("is_battery_present")
  isLocked         Boolean     @default(false) @map("is_locked")
  batteryUid       String?     @map("battery_uid") @db.VarChar(50)
  lastUpdated      DateTime    @default(now()) @map("last_updated") @db.Timestamptz(6)
  battery          Battery?    @relation(fields: [batteryUid], references: [uid])
  station          Station     @relation(fields: [stationId], references: [id], onDelete: Cascade)
  warehouses       Warehouse[]

  @@unique([stationId, slotNumber])
  @@map("slots")
}

model Admin {
  id              Int              @id @default(autoincrement())
  username        String           @unique @db.VarChar(50)
  passwordHash    String           @map("password_hash") @db.VarChar(255)
  fullName        String?          @map("full_name") @db.VarChar(100)
  role            String           @default("user") @db.VarChar(50)
  createdAt       DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  maintenanceLogs MaintenanceLog[]

  @@map("admins")
}

model TransactionLog {
  id              Int       @id @default(autoincrement())
  customerId      Int       @map("customer_id")
  stationId       Int       @map("station_id")
  requestType     String    @default("swap") @map("request_type") @db.VarChar(50)
  oldBatteryUid   String?   @map("old_battery_uid") @db.VarChar(50)
  slotIn          Int?      @map("slot_in")
  newBatteryUid   String?   @map("new_battery_uid") @db.VarChar(50)
  slotOut         Int?      @map("slot_out")
  cost            Float     @default(7000)
  transactionTime DateTime  @default(now()) @map("transaction_time") @db.Timestamptz(6)
  completedTime   DateTime? @map("completed_time") @db.Timestamptz(6)
  status          String    @default("pending") @db.VarChar(50)
  customer        Customer  @relation(fields: [customerId], references: [id])
  newBattery      Battery?  @relation("NewBattery", fields: [newBatteryUid], references: [uid])
  oldBattery      Battery?  @relation("OldBattery", fields: [oldBatteryUid], references: [uid])
  station         Station   @relation(fields: [stationId], references: [id])

  @@map("transaction_logs")
}

model MaintenanceLog {
  id              Int       @id @default(autoincrement())
  stationId       Int       @map("station_id")
  adminId         Int?      @map("admin_id")
  maintenanceType String    @map("maintenance_type") @db.VarChar(50)
  description     String?
  startTime       DateTime  @default(now()) @map("start_time") @db.Timestamptz(6)
  endTime         DateTime? @map("end_time") @db.Timestamptz(6)
  status          String    @default("in_progress") @db.VarChar(50)
  admin           Admin?    @relation(fields: [adminId], references: [id])
  station         Station   @relation(fields: [stationId], references: [id])

  @@map("maintenance_logs")
}

model Warehouse {
  id            Int                @id @default(autoincrement())
  slotId        Int                @map("slot_id")
  totalCapacity Int                @default(4) @map("total_capacity")
  slot          Slot               @relation(fields: [slotId], references: [id], onDelete: Cascade)
  batteries     WarehouseBattery[]

  @@map("warehouse")
}

model WarehouseBattery {
  id          Int       @id @default(autoincrement())
  warehouseId Int       @map("warehouse_id")
  batteryUid  String    @map("battery_uid") @db.VarChar(50)
  insertedAt  DateTime  @default(now()) @map("inserted_at") @db.Timestamp(6)
  battery     Battery   @relation(fields: [batteryUid], references: [uid])
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@map("warehouse_batteries")
}

model Feedback {
  feedbackId   Int      @id @default(autoincrement()) @map("feedback_id")
  customerId   Int      @map("customer_id")
  content      String
  rating       Int?
  feedbackDate DateTime @default(now()) @map("feedback_date") @db.Timestamp(6)
  customer     Customer @relation(fields: [customerId], references: [id])

  @@map("feedback")
}

model Reservation {
  id           Int      @id @default(autoincrement())
  customerId   Int      @map("customer_id")
  stationId    Int      @map("station_id")
  reservedTime DateTime @map("reserved_time") @db.Timestamptz(6)
  status       String   @default("pending") @db.VarChar(50)
  batteryUid   String?  @map("battery_uid") @db.VarChar(50)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  expiresAt    DateTime @map("expires_at") @db.Timestamptz(6)
  customer     Customer @relation(fields: [customerId], references: [id])
  station      Station  @relation(fields: [stationId], references: [id])

  @@map("reservations")
}

model Payment {
  id            Int       @id @default(autoincrement())
  customerId    Int       @map("customer_id")
  orderId       String    @unique @map("order_id") @db.VarChar(100)
  requestId     String    @map("request_id") @db.VarChar(100)
  amount        Float
  status        String    @default("pending") @db.VarChar(50)
  paymentMethod String    @map("payment_method") @db.VarChar(50)
  transactionId String?   @map("transaction_id") @db.VarChar(100)
  momoData      String?   @map("momo_data")
  errorMessage  String?   @map("error_message")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  completedAt   DateTime? @map("completed_at") @db.Timestamptz(6)

  @@map("payments")
}
