#!/bin/bash

# =====================================================
# SCRIPT KHá»I Táº O DATABASE CHO Dá»° ÃN EV-SWAP
# =====================================================
# Script nÃ y sáº½ tá»± Ä‘á»™ng:
# 1. Táº¡o database
# 2. Cháº¡y cÃ¡c migrations
# 3. Seed dá»¯ liá»‡u máº«u
# =====================================================

set -e  # Dá»«ng náº¿u cÃ³ lá»—i

echo "ğŸš€ Báº¯t Ä‘áº§u khá»Ÿi táº¡o database cho dá»± Ã¡n EV-SWAP..."
echo ""

# MÃ u sáº¯c cho output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Äá»c thÃ´ng tin tá»« .env hoáº·c sá»­ dá»¥ng máº·c Ä‘á»‹nh
DB_USER=${DB_USER:-postgres}
DB_PASSWORD=${DB_PASSWORD:-123}
DB_HOST=${DB_HOST:-localhost}
DB_PORT=${DB_PORT:-5432}
DB_NAME=${DB_NAME:-doan_db}

echo -e "${YELLOW}ğŸ“‹ ThÃ´ng tin káº¿t ná»‘i:${NC}"
echo "   Host: $DB_HOST"
echo "   Port: $DB_PORT"
echo "   User: $DB_USER"
echo "   Database: $DB_NAME"
echo ""

# HÃ m kiá»ƒm tra PostgreSQL cÃ³ cháº¡y khÃ´ng
check_postgres() {
    echo -e "${YELLOW}ğŸ” Kiá»ƒm tra PostgreSQL...${NC}"
    if ! command -v psql &> /dev/null; then
        echo -e "${RED}âŒ PostgreSQL chÆ°a Ä‘Æ°á»£c cÃ i Ä‘áº·t!${NC}"
        exit 1
    fi
    
    if ! pg_isready -h $DB_HOST -p $DB_PORT &> /dev/null; then
        echo -e "${RED}âŒ PostgreSQL khÃ´ng cháº¡y hoáº·c khÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c!${NC}"
        echo "HÃ£y khá»Ÿi Ä‘á»™ng PostgreSQL: sudo service postgresql start"
        exit 1
    fi
    
    echo -e "${GREEN}âœ… PostgreSQL Ä‘ang cháº¡y${NC}"
    echo ""
}

# HÃ m táº¡o database
create_database() {
    echo -e "${YELLOW}ğŸ“Š Táº¡o database...${NC}"
    
    # Kiá»ƒm tra xem database Ä‘Ã£ tá»“n táº¡i chÆ°a
    if PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -lqt | cut -d \| -f 1 | grep -qw $DB_NAME; then
        echo -e "${YELLOW}âš ï¸  Database '$DB_NAME' Ä‘Ã£ tá»“n táº¡i${NC}"
        read -p "Báº¡n cÃ³ muá»‘n xÃ³a vÃ  táº¡o láº¡i? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo -e "${YELLOW}ğŸ—‘ï¸  Äang xÃ³a database cÅ©...${NC}"
            PGPASSWORD=$DB_PASSWORD dropdb -h $DB_HOST -p $DB_PORT -U $DB_USER $DB_NAME
            echo -e "${GREEN}âœ… ÄÃ£ xÃ³a database cÅ©${NC}"
        else
            echo -e "${YELLOW}â­ï¸  Bá» qua viá»‡c táº¡o database${NC}"
            echo ""
            return
        fi
    fi
    
    PGPASSWORD=$DB_PASSWORD createdb -h $DB_HOST -p $DB_PORT -U $DB_USER $DB_NAME
    echo -e "${GREEN}âœ… Database '$DB_NAME' Ä‘Ã£ Ä‘Æ°á»£c táº¡o${NC}"
    echo ""
}

# HÃ m cháº¡y SQL script
run_sql_script() {
    echo -e "${YELLOW}ğŸ“ Cháº¡y SQL script táº¡o báº£ng vÃ  dá»¯ liá»‡u máº«u...${NC}"
    
    if [ -f "setup-database.sql" ]; then
        PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -f setup-database.sql
        echo -e "${GREEN}âœ… ÄÃ£ táº¡o cÃ¡c báº£ng vÃ  dá»¯ liá»‡u máº«u${NC}"
    else
        echo -e "${RED}âŒ KhÃ´ng tÃ¬m tháº¥y file setup-database.sql${NC}"
        exit 1
    fi
    echo ""
}

# HÃ m cháº¡y Prisma migrations (náº¿u cÃ³)
run_prisma() {
    echo -e "${YELLOW}ğŸ”„ Cháº¡y Prisma...${NC}"
    
    if [ -f "prisma/schema.prisma" ]; then
        # Generate Prisma Client
        echo "Generating Prisma Client..."
        npx prisma generate
        echo -e "${GREEN}âœ… Prisma Client Ä‘Ã£ Ä‘Æ°á»£c táº¡o${NC}"
        
        # Prisma db push (sync schema)
        # echo "Syncing database schema..."
        # npx prisma db push --skip-generate
        # echo -e "${GREEN}âœ… Database schema Ä‘Ã£ Ä‘Æ°á»£c Ä‘á»“ng bá»™${NC}"
    else
        echo -e "${YELLOW}â­ï¸  KhÃ´ng tÃ¬m tháº¥y Prisma schema${NC}"
    fi
    echo ""
}

# HÃ m kiá»ƒm tra káº¿t quáº£
verify_setup() {
    echo -e "${YELLOW}ğŸ” Kiá»ƒm tra káº¿t quáº£...${NC}"
    
    PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -c "
        SELECT 
            'stations' as table_name, COUNT(*) as records FROM stations
        UNION ALL
        SELECT 'batteries', COUNT(*) FROM batteries
        UNION ALL
        SELECT 'customers', COUNT(*) FROM customers
        UNION ALL
        SELECT 'slots', COUNT(*) FROM slots
        UNION ALL
        SELECT 'admins', COUNT(*) FROM admins
        UNION ALL
        SELECT 'reservations', COUNT(*) FROM reservations;
    "
    echo ""
}

# Main execution
main() {
    check_postgres
    create_database
    run_sql_script
    run_prisma
    verify_setup
    
    echo -e "${GREEN}ğŸ‰ HOÃ€N Táº¤T!${NC}"
    echo ""
    echo -e "${GREEN}âœ… Database Ä‘Ã£ sáºµn sÃ ng sá»­ dá»¥ng${NC}"
    echo ""
    echo "ğŸ“ TÃ i khoáº£n máº·c Ä‘á»‹nh:"
    echo "   ğŸ” Admin:  username: admin,     password: admin123"
    echo "   ğŸ‘¤ User:   username: testuser,  password: 123456"
    echo "   ğŸ‘¤ User:   username: testlogin, password: 123456"
    echo ""
    echo "ğŸš€ Äá»ƒ cháº¡y backend:"
    echo "   cd /home/vanh/doan/ev-swap-backend"
    echo "   node src/index.js"
    echo ""
    echo "ğŸ’¡ Connection string:"
    echo "   postgresql://$DB_USER:$DB_PASSWORD@$DB_HOST:$DB_PORT/$DB_NAME"
    echo ""
}

# Cháº¡y script
main
