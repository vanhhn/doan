================================================================================
CHÆ¯Æ NG 3: PHÃT TRIá»‚N Há»† THá»NG
Pháº§n 3.3: PHÃT TRIá»‚N CÆ  Sá» Dá»® LIá»†U
Pháº§n thá»±c hiá»‡n: NgÃ´ Viá»‡t Anh (phá»‘i há»£p vá»›i Pháº¡m Ngá»c ÄÄƒng)
================================================================================

3.3.1. Tá»”NG QUAN QUY TRÃŒNH PHÃT TRIá»‚N

QuÃ¡ trÃ¬nh phÃ¡t triá»ƒn cÆ¡ sá»Ÿ dá»¯ liá»‡u trong dá»± Ã¡n EV-Swap Ä‘Æ°á»£c thá»±c hiá»‡n theo 
cÃ¡c bÆ°á»›c sau:

1. Thiáº¿t láº­p mÃ´i trÆ°á»ng phÃ¡t triá»ƒn (Development Environment)
2. Äá»‹nh nghÄ©a schema vá»›i Prisma Schema Language
3. Táº¡o migrations Ä‘á»ƒ Ä‘á»“ng bá»™ schema vá»›i database
4. Seed dá»¯ liá»‡u máº«u (test data)
5. Deploy lÃªn production (Heroku Postgres)
6. Monitoring vÃ  optimization

3.3.2. THIáº¾T Láº¬P MÃ”I TRÆ¯á»œNG PHÃT TRIá»‚N

3.3.2.1. CÃ i Ä‘áº·t Dependencies

File: package.json
```json
{
  "name": "ev-swap-backend",
  "version": "1.0.0",
  "dependencies": {
    "@prisma/client": "^5.22.0",
    "express": "^4.21.1",
    "bcryptjs": "^2.4.3",
    "jsonwebtoken": "^9.0.2",
    "dotenv": "^16.4.5"
  },
  "devDependencies": {
    "prisma": "^5.22.0",
    "nodemon": "^3.0.1"
  },
  "scripts": {
    "dev": "nodemon src/index.js",
    "start": "node src/index.js",
    "prisma:generate": "prisma generate",
    "prisma:migrate": "prisma migrate dev",
    "prisma:deploy": "prisma migrate deploy",
    "prisma:studio": "prisma studio",
    "seed": "node seed-heroku.js"
  }
}
```

Install commands:
```bash
# Initialize Node.js project
npm init -y

# Install Prisma
npm install @prisma/client
npm install prisma --save-dev

# Initialize Prisma
npx prisma init

# Cáº¥u trÃºc thÆ° má»¥c Ä‘Æ°á»£c táº¡o:
# ev-swap-backend/
# â”œâ”€â”€ prisma/
# â”‚   â””â”€â”€ schema.prisma
# â””â”€â”€ .env
```

3.3.2.2. Cáº¥u hÃ¬nh Database Connection

File: .env
```
DATABASE_URL="postgresql://username:password@localhost:5432/ev_swap_dev?schema=public"
JWT_SECRET="your-secret-key-here"
PORT=3000
```

Giáº£i thÃ­ch connection string:
- postgresql:// - Protocol
- username:password - Database credentials
- localhost:5432 - Host and port
- ev_swap_dev - Database name
- ?schema=public - PostgreSQL schema (default: public)

Cho production (Heroku):
```
DATABASE_URL="postgres://u123abc:p456def@ec2-host.amazonaws.com:5432/d789ghi"
```

3.3.2.3. Khá»Ÿi táº¡o Prisma Client

File: src/config/database.js
```javascript
const { PrismaClient } = require('@prisma/client');

const prisma = new PrismaClient({
  log: ['query', 'info', 'warn', 'error'], // Logging levels
});

module.exports = prisma;
```

Sá»­ dá»¥ng trong controllers:
```javascript
const prisma = require('../config/database');

// Example query
const customers = await prisma.customer.findMany();
```

3.3.3. PRISMA SCHEMA LANGUAGE (PSL)

3.3.3.1. Cáº¥u trÃºc File schema.prisma

File: prisma/schema.prisma

```prisma
// Datasource configuration
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Generator configuration
generator client {
  provider = "prisma-client-js"
}

// Model definitions
model Customer {
  id                Int      @id @default(autoincrement())
  fullName          String   @map("full_name") @db.VarChar(100)
  username          String   @unique @db.VarChar(50)
  passwordHash      String   @map("password_hash") @db.VarChar(255)
  // ... (rest of the schema)
}
```

3.3.3.2. Prisma Schema Syntax

CÃ¡c thÃ nh pháº§n chÃ­nh:

a) Data Types:
```prisma
Int          // Integer
String       // Text
Boolean      // True/False
Float        // Floating point
DateTime     // Timestamp
Json         // JSON data (Postgres JSONB)
```

b) Field Modifiers:
```prisma
@id                    // Primary key
@unique                // Unique constraint
@default(value)        // Default value
@map("column_name")    // Map to different column name
@@map("table_name")    // Map to different table name
@db.VarChar(100)       // Specific database type
@relation(...)         // Define relationships
@updatedAt             // Auto-update on change
```

c) Relations:
```prisma
// One-to-Many
model Customer {
  id              Int      @id
  transactionLogs TransactionLog[]
}

model TransactionLog {
  id         Int      @id
  customerId Int
  customer   Customer @relation(fields: [customerId], references: [id])
}

// One-to-One
model Customer {
  id                Int      @id
  currentBatteryUid String?
  currentBattery    Battery? @relation(fields: [currentBatteryUid], references: [uid])
}

// Many-to-Many (implicit)
// Prisma tá»± Ä‘á»™ng táº¡o join table
```

3.3.3.3. Prisma Schema Äáº§y Äá»§ - 12 Models

File: prisma/schema.prisma (Complete)

```prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// 1. Customer Model
model Customer {
  id                Int              @id @default(autoincrement())
  fullName          String           @map("full_name") @db.VarChar(100)
  username          String           @unique @db.VarChar(50)
  passwordHash      String           @map("password_hash") @db.VarChar(255)
  phone             String?          @unique @db.VarChar(20)
  email             String?          @unique @db.VarChar(100)
  currentBatteryUid String?          @map("current_battery_uid") @db.VarChar(50)
  totalSwaps        Int              @default(0) @map("total_swaps")
  balance           Float            @default(0)
  avatarUrl         String?          @map("avatar_url")
  createdAt         DateTime         @default(now()) @map("created_at")
  
  currentBattery    Battery?         @relation("CustomerCurrentBattery", fields: [currentBatteryUid], references: [uid], onDelete: SetNull)
  transactionLogs   TransactionLog[]
  payments          Payment[]
  reservations      Reservation[]
  feedbacks         Feedback[]

  @@map("customers")
}

// 2. Battery Model
model Battery {
  uid               String            @id @db.VarChar(50)
  status            String            @default("in_stock") @db.VarChar(50)
  chargeCycles      Int               @default(0) @map("charge_cycles")
  lastCharged       DateTime?         @map("last_charged")
  createdAt         DateTime          @default(now()) @map("created_at")
  
  customersUsing    Customer[]        @relation("CustomerCurrentBattery")
  slots             Slot[]
  transactionsOld   TransactionLog[]  @relation("OldBattery")
  transactionsNew   TransactionLog[]  @relation("NewBattery")
  warehouseBatteries WarehouseBattery[]

  @@map("batteries")
}

// 3. Station Model
model Station {
  id                Int               @id @default(autoincrement())
  name              String            @unique @db.VarChar(100)
  location          String?           @db.VarChar(255)
  status            String            @default("inactive") @db.VarChar(50)
  totalSlots        Int               @default(6) @map("total_slots")
  availableSlots    Int               @default(6) @map("available_slots")
  lastMaintenance   DateTime?         @map("last_maintenance")
  createdAt         DateTime          @default(now()) @map("created_at")
  
  slots             Slot[]
  transactionLogs   TransactionLog[]
  reservations      Reservation[]
  maintenanceLogs   MaintenanceLog[]

  @@map("stations")
}

// 4. Slot Model
model Slot {
  id                Int       @id @default(autoincrement())
  stationId         Int       @map("station_id")
  slotNumber        Int       @map("slot_number")
  status            String    @default("empty") @db.VarChar(50)
  isBatteryPresent  Boolean   @default(false) @map("is_battery_present")
  isLocked          Boolean   @default(false) @map("is_locked")
  batteryUid        String?   @map("battery_uid") @db.VarChar(50)
  lastUpdated       DateTime  @default(now()) @map("last_updated")
  
  station           Station   @relation(fields: [stationId], references: [id], onDelete: Cascade)
  battery           Battery?  @relation(fields: [batteryUid], references: [uid], onDelete: SetNull)
  warehouse         Warehouse?

  @@unique([stationId, slotNumber])
  @@map("slots")
}

// 5. TransactionLog Model
model TransactionLog {
  id                Int       @id @default(autoincrement())
  customerId        Int       @map("customer_id")
  stationId         Int       @map("station_id")
  requestType       String    @default("swap") @map("request_type") @db.VarChar(50)
  oldBatteryUid     String?   @map("old_battery_uid") @db.VarChar(50)
  slotIn            Int?      @map("slot_in")
  newBatteryUid     String?   @map("new_battery_uid") @db.VarChar(50)
  slotOut           Int?      @map("slot_out")
  cost              Float     @default(7000)
  transactionTime   DateTime  @default(now()) @map("transaction_time")
  completedTime     DateTime? @map("completed_time")
  status            String    @default("pending") @db.VarChar(50)
  
  customer          Customer  @relation(fields: [customerId], references: [id])
  station           Station   @relation(fields: [stationId], references: [id])
  oldBattery        Battery?  @relation("OldBattery", fields: [oldBatteryUid], references: [uid], onDelete: SetNull)
  newBattery        Battery?  @relation("NewBattery", fields: [newBatteryUid], references: [uid], onDelete: SetNull)

  @@map("transaction_logs")
}

// 6. Payment Model
model Payment {
  id                Int       @id @default(autoincrement())
  customerId        Int       @map("customer_id")
  orderId           String    @unique @map("order_id") @db.VarChar(50)
  requestId         String    @map("request_id") @db.VarChar(50)
  amount            Float
  status            String    @default("pending") @db.VarChar(50)
  paymentMethod     String    @map("payment_method") @db.VarChar(50)
  transactionId     String?   @map("transaction_id") @db.VarChar(100)
  momoData          Json?     @map("momo_data")
  errorMessage      String?   @map("error_message")
  createdAt         DateTime  @default(now()) @map("created_at")
  completedAt       DateTime? @map("completed_at")
  
  customer          Customer  @relation(fields: [customerId], references: [id])

  @@map("payments")
}

// 7. Reservation Model
model Reservation {
  id                Int       @id @default(autoincrement())
  customerId        Int       @map("customer_id")
  stationId         Int       @map("station_id")
  reservedTime      DateTime  @map("reserved_time")
  status            String    @default("pending") @db.VarChar(50)
  batteryUid        String?   @map("battery_uid") @db.VarChar(50)
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  customer          Customer  @relation(fields: [customerId], references: [id])
  station           Station   @relation(fields: [stationId], references: [id])

  @@map("reservations")
}

// 8. Feedback Model
model Feedback {
  feedbackId        Int       @id @default(autoincrement()) @map("feedback_id")
  customerId        Int       @map("customer_id")
  content           String
  rating            Int?
  feedbackDate      DateTime  @default(now()) @map("feedback_date")
  
  customer          Customer  @relation(fields: [customerId], references: [id])

  @@map("feedbacks")
}

// 9. Admin Model
model Admin {
  id                Int       @id @default(autoincrement())
  username          String    @unique @db.VarChar(50)
  passwordHash      String    @map("password_hash") @db.VarChar(255)
  fullName          String    @map("full_name") @db.VarChar(100)
  role              String    @default("user") @db.VarChar(50)
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @default(now()) @updatedAt @map("updated_at")
  
  maintenanceLogs   MaintenanceLog[]

  @@map("admins")
}

// 10. MaintenanceLog Model
model MaintenanceLog {
  id                Int       @id @default(autoincrement())
  stationId         Int       @map("station_id")
  adminId           Int?      @map("admin_id")
  maintenanceType   String    @map("maintenance_type") @db.VarChar(100)
  description       String?
  status            String    @default("pending") @db.VarChar(50)
  scheduledDate     DateTime? @map("scheduled_date")
  completedDate     DateTime? @map("completed_date")
  createdAt         DateTime  @default(now()) @map("created_at")
  
  station           Station   @relation(fields: [stationId], references: [id], onDelete: Cascade)
  admin             Admin?    @relation(fields: [adminId], references: [id], onDelete: SetNull)

  @@map("maintenance_logs")
}

// 11. Warehouse Model
model Warehouse {
  id                Int       @id @default(autoincrement())
  slotId            Int       @unique @map("slot_id")
  totalCapacity     Int       @default(10) @map("total_capacity")
  currentCount      Int       @default(0) @map("current_count")
  
  slot              Slot      @relation(fields: [slotId], references: [id], onDelete: Cascade)
  warehouseBatteries WarehouseBattery[]

  @@map("warehouse")
}

// 12. WarehouseBattery Model
model WarehouseBattery {
  id                Int       @id @default(autoincrement())
  warehouseId       Int       @map("warehouse_id")
  batteryUid        String    @map("battery_uid") @db.VarChar(50)
  insertedAt        DateTime  @default(now()) @map("inserted_at")
  
  warehouse         Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  battery           Battery   @relation(fields: [batteryUid], references: [uid], onDelete: Cascade)

  @@map("warehouse_batteries")
}
```

**Tá»•ng káº¿t 12 Models:**
1. Customer - KhÃ¡ch hÃ ng (Mobile App)
2. Battery - Pin (Shared)
3. Station - Tráº¡m Ä‘á»•i pin (Shared)
4. Slot - Ã” cáº¯m pin (Shared)
5. TransactionLog - Lá»‹ch sá»­ giao dá»‹ch (Mobile App)
6. Payment - Thanh toÃ¡n MoMo (Mobile App)
7. Reservation - Äáº·t chá»— trÆ°á»›c (Mobile App)
8. Feedback - Pháº£n há»“i khÃ¡ch hÃ ng (Mobile App)
9. Admin - Quáº£n trá»‹ viÃªn (Admin Web)
10. MaintenanceLog - Lá»‹ch sá»­ báº£o trÃ¬ (Admin Web)
11. Warehouse - Kho lÆ°u trá»¯ pin (Admin Web)
12. WarehouseBattery - Pin trong kho (Admin Web)

3.3.4. PRISMA MIGRATIONS

3.3.4.1. Táº¡o Migration Äáº§u TiÃªn

Sau khi Ä‘á»‹nh nghÄ©a schema, táº¡o migration:

```bash
npx prisma migrate dev --name init
```

Output:
```
Environment variables loaded from .env
Prisma schema loaded from prisma/schema.prisma
Datasource "db": PostgreSQL database "ev_swap_dev"

Applying migration `20241201_init`

The following migration(s) have been created and applied from new schema changes:

migrations/
  â””â”€ 20241201_init/
      â””â”€ migration.sql

Your database is now in sync with your schema.

Running generate... (Use --skip-generate to skip)
âœ” Generated Prisma Client
```

File: prisma/migrations/20241201_init/migration.sql
```sql
-- CreateTable
CREATE TABLE "customers" (
    "id" SERIAL NOT NULL,
    "full_name" VARCHAR(100) NOT NULL,
    "username" VARCHAR(50) NOT NULL,
    "password_hash" VARCHAR(255) NOT NULL,
    "phone" VARCHAR(20),
    "email" VARCHAR(100),
    "current_battery_uid" VARCHAR(50),
    "total_swaps" INTEGER NOT NULL DEFAULT 0,
    "balance" DOUBLE PRECISION NOT NULL DEFAULT 0,
    "avatar_url" TEXT,
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "customers_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "batteries" (
    "uid" VARCHAR(50) NOT NULL,
    "status" VARCHAR(50) NOT NULL DEFAULT 'in_stock',
    "charge_cycles" INTEGER NOT NULL DEFAULT 0,
    "last_charged" TIMESTAMP(3),
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "batteries_pkey" PRIMARY KEY ("uid")
);

-- CreateTable
CREATE TABLE "stations" (
    "id" SERIAL NOT NULL,
    "name" VARCHAR(100) NOT NULL,
    "location" VARCHAR(255),
    "status" VARCHAR(50) NOT NULL DEFAULT 'inactive',
    "total_slots" INTEGER NOT NULL DEFAULT 6,
    "available_slots" INTEGER NOT NULL DEFAULT 6,
    "last_maintenance" TIMESTAMP(3),
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "stations_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "slots" (
    "id" SERIAL NOT NULL,
    "station_id" INTEGER NOT NULL,
    "slot_number" INTEGER NOT NULL,
    "status" VARCHAR(50) NOT NULL DEFAULT 'empty',
    "is_battery_present" BOOLEAN NOT NULL DEFAULT false,
    "is_locked" BOOLEAN NOT NULL DEFAULT false,
    "battery_uid" VARCHAR(50),
    "last_updated" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "slots_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "transaction_logs" (
    "id" SERIAL NOT NULL,
    "customer_id" INTEGER NOT NULL,
    "station_id" INTEGER NOT NULL,
    "request_type" VARCHAR(50) NOT NULL DEFAULT 'swap',
    "old_battery_uid" VARCHAR(50),
    "slot_in" INTEGER,
    "new_battery_uid" VARCHAR(50),
    "slot_out" INTEGER,
    "cost" DOUBLE PRECISION NOT NULL DEFAULT 7000,
    "transaction_time" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "completed_time" TIMESTAMP(3),
    "status" VARCHAR(50) NOT NULL DEFAULT 'pending',

    CONSTRAINT "transaction_logs_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "payments" (
    "id" SERIAL NOT NULL,
    "customer_id" INTEGER NOT NULL,
    "order_id" VARCHAR(50) NOT NULL,
    "request_id" VARCHAR(50) NOT NULL,
    "amount" DOUBLE PRECISION NOT NULL,
    "status" VARCHAR(50) NOT NULL DEFAULT 'pending',
    "payment_method" VARCHAR(50) NOT NULL,
    "transaction_id" VARCHAR(100),
    "momo_data" JSONB,
    "error_message" TEXT,
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "completed_at" TIMESTAMP(3),

    CONSTRAINT "payments_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "reservations" (
    "id" SERIAL NOT NULL,
    "customer_id" INTEGER NOT NULL,
    "station_id" INTEGER NOT NULL,
    "reserved_time" TIMESTAMP(3) NOT NULL,
    "status" VARCHAR(50) NOT NULL DEFAULT 'pending',
    "battery_uid" VARCHAR(50),
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "reservations_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "feedbacks" (
    "feedback_id" SERIAL NOT NULL,
    "customer_id" INTEGER NOT NULL,
    "content" TEXT NOT NULL,
    "rating" INTEGER,
    "feedback_date" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "feedbacks_pkey" PRIMARY KEY ("feedback_id")
);

-- CreateTable
CREATE TABLE "admins" (
    "id" SERIAL NOT NULL,
    "username" VARCHAR(50) NOT NULL,
    "password_hash" VARCHAR(255) NOT NULL,
    "full_name" VARCHAR(100) NOT NULL,
    "role" VARCHAR(50) NOT NULL DEFAULT 'user',
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "admins_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "maintenance_logs" (
    "id" SERIAL NOT NULL,
    "station_id" INTEGER NOT NULL,
    "admin_id" INTEGER,
    "maintenance_type" VARCHAR(100) NOT NULL,
    "description" TEXT,
    "status" VARCHAR(50) NOT NULL DEFAULT 'pending',
    "scheduled_date" TIMESTAMP(3),
    "completed_date" TIMESTAMP(3),
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "maintenance_logs_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "warehouse" (
    "id" SERIAL NOT NULL,
    "slot_id" INTEGER NOT NULL,
    "total_capacity" INTEGER NOT NULL DEFAULT 10,
    "current_count" INTEGER NOT NULL DEFAULT 0,

    CONSTRAINT "warehouse_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "warehouse_batteries" (
    "id" SERIAL NOT NULL,
    "warehouse_id" INTEGER NOT NULL,
    "battery_uid" VARCHAR(50) NOT NULL,
    "inserted_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "warehouse_batteries_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "customers_username_key" ON "customers"("username");

-- CreateIndex
CREATE UNIQUE INDEX "customers_phone_key" ON "customers"("phone");

-- CreateIndex
CREATE UNIQUE INDEX "customers_email_key" ON "customers"("email");

-- CreateIndex
CREATE UNIQUE INDEX "stations_name_key" ON "stations"("name");

-- CreateIndex
CREATE UNIQUE INDEX "slots_station_id_slot_number_key" ON "slots"("station_id", "slot_number");

-- CreateIndex
CREATE UNIQUE INDEX "payments_order_id_key" ON "payments"("order_id");

-- CreateIndex
CREATE UNIQUE INDEX "admins_username_key" ON "admins"("username");

-- CreateIndex
CREATE UNIQUE INDEX "warehouse_slot_id_key" ON "warehouse"("slot_id");

-- AddForeignKey
ALTER TABLE "customers" ADD CONSTRAINT "customers_current_battery_uid_fkey" 
  FOREIGN KEY ("current_battery_uid") REFERENCES "batteries"("uid") 
  ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "slots" ADD CONSTRAINT "slots_station_id_fkey" 
  FOREIGN KEY ("station_id") REFERENCES "stations"("id") 
  ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "slots" ADD CONSTRAINT "slots_battery_uid_fkey" 
  FOREIGN KEY ("battery_uid") REFERENCES "batteries"("uid") 
  ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "transaction_logs" ADD CONSTRAINT "transaction_logs_customer_id_fkey" 
  FOREIGN KEY ("customer_id") REFERENCES "customers"("id") 
  ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "transaction_logs" ADD CONSTRAINT "transaction_logs_station_id_fkey" 
  FOREIGN KEY ("station_id") REFERENCES "stations"("id") 
  ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "transaction_logs" ADD CONSTRAINT "transaction_logs_old_battery_uid_fkey" 
  FOREIGN KEY ("old_battery_uid") REFERENCES "batteries"("uid") 
  ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "transaction_logs" ADD CONSTRAINT "transaction_logs_new_battery_uid_fkey" 
  FOREIGN KEY ("new_battery_uid") REFERENCES "batteries"("uid") 
  ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "payments" ADD CONSTRAINT "payments_customer_id_fkey" 
  FOREIGN KEY ("customer_id") REFERENCES "customers"("id") 
  ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "reservations" ADD CONSTRAINT "reservations_customer_id_fkey" 
  FOREIGN KEY ("customer_id") REFERENCES "customers"("id") 
  ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "reservations" ADD CONSTRAINT "reservations_station_id_fkey" 
  FOREIGN KEY ("station_id") REFERENCES "stations"("id") 
  ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "feedbacks" ADD CONSTRAINT "feedbacks_customer_id_fkey" 
  FOREIGN KEY ("customer_id") REFERENCES "customers"("id") 
  ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "maintenance_logs" ADD CONSTRAINT "maintenance_logs_station_id_fkey" 
  FOREIGN KEY ("station_id") REFERENCES "stations"("id") 
  ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "maintenance_logs" ADD CONSTRAINT "maintenance_logs_admin_id_fkey" 
  FOREIGN KEY ("admin_id") REFERENCES "admins"("id") 
  ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "warehouse" ADD CONSTRAINT "warehouse_slot_id_fkey" 
  FOREIGN KEY ("slot_id") REFERENCES "slots"("id") 
  ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "warehouse_batteries" ADD CONSTRAINT "warehouse_batteries_warehouse_id_fkey" 
  FOREIGN KEY ("warehouse_id") REFERENCES "warehouse"("id") 
  ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "warehouse_batteries" ADD CONSTRAINT "warehouse_batteries_battery_uid_fkey" 
  FOREIGN KEY ("battery_uid") REFERENCES "batteries"("uid") 
  ON DELETE CASCADE ON UPDATE CASCADE;
```

3.3.4.2. Quy trÃ¬nh Migration Workflow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Modify schema.prisma                                    â”‚
â”‚    (Add new field, model, or relation)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. npx prisma migrate dev --name <migration_name>          â”‚
â”‚    - Prisma detects schema changes                         â”‚
â”‚    - Generates SQL migration file                          â”‚
â”‚    - Applies migration to dev database                     â”‚
â”‚    - Regenerates Prisma Client                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Test migration locally                                  â”‚
â”‚    - Run application                                       â”‚
â”‚    - Verify new fields/relations work                      â”‚
â”‚    - Test queries with Prisma Studio                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Commit migration files to Git                           â”‚
â”‚    git add prisma/migrations/                              â”‚
â”‚    git commit -m "Add migration: <description>"            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Deploy to production                                    â”‚
â”‚    npx prisma migrate deploy                               â”‚
â”‚    (Runs pending migrations on production database)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

3.3.4.3. VÃ­ dá»¥ Migration - ThÃªm trÆ°á»ng email

Step 1: Modify schema.prisma
```prisma
model Customer {
  id           Int      @id @default(autoincrement())
  fullName     String   @map("full_name")
  username     String   @unique
  // ... existing fields
  
  // NEW FIELD
  email        String?  @unique @db.VarChar(100)  // Add email field
  
  createdAt    DateTime @default(now()) @map("created_at")
}
```

Step 2: Create migration
```bash
npx prisma migrate dev --name add_email_to_customers
```

Generated migration file:
```sql
-- AlterTable
ALTER TABLE "customers" ADD COLUMN "email" VARCHAR(100);

-- CreateIndex
CREATE UNIQUE INDEX "customers_email_key" ON "customers"("email");
```

Step 3: Verify with Prisma Client
```javascript
const customer = await prisma.customer.create({
  data: {
    fullName: "Test User",
    username: "testuser",
    passwordHash: "hashed",
    email: "test@example.com"  // New field works!
  }
});
```

3.3.5. SEEDING Dá»® LIá»†U

3.3.5.1. Táº¡o Seed Script

File: seed-heroku.js

```javascript
const { PrismaClient } = require('@prisma/client');
const bcrypt = require('bcryptjs');

const prisma = new PrismaClient();

async function main() {
  console.log('ğŸŒ± Báº¯t Ä‘áº§u seeding database...');

  // 1. Táº¡o batteries
  console.log('ğŸ“¦ Táº¡o batteries...');
  const batteries = [];
  for (let i = 1; i <= 20; i++) {
    const battery = await prisma.battery.create({
      data: {
        uid: `UID-${String(i).padStart(3, '0')}`,
        status: i <= 15 ? 'in_stock' : 'charging',
        chargeCycles: Math.floor(Math.random() * 200),
        lastCharged: new Date()
      }
    });
    batteries.push(battery);
    console.log(`  âœ“ Created battery: ${battery.uid}`);
  }

  // 2. Táº¡o stations vá»›i location format má»›i
  console.log('ğŸ¢ Táº¡o stations...');
  const stationsData = [
    {
      name: 'Tráº¡m Äáº¡i há»c BÃ¡ch Khoa',
      location: 'Äáº¡i há»c BÃ¡ch Khoa HÃ  Ná»™i, 1 Äáº¡i Cá»“ Viá»‡t;21.0047;105.8431',
      status: 'active',
      totalSlots: 6,
      availableSlots: 4
    },
    {
      name: 'Tráº¡m PTIT',
      location: 'Há»c viá»‡n CÃ´ng nghá»‡ BÆ°u chÃ­nh Viá»…n thÃ´ng HÃ  Ná»™i;21.0063;105.8433',
      status: 'active',
      totalSlots: 6,
      availableSlots: 5
    },
    {
      name: 'Tráº¡m Äáº¡i há»c Quá»‘c gia',
      location: 'Äáº¡i há»c Quá»‘c gia HÃ  Ná»™i, 144 XuÃ¢n Thá»§y;21.0380;105.7829',
      status: 'active',
      totalSlots: 6,
      availableSlots: 3
    },
    {
      name: 'Tráº¡m Keangnam',
      location: 'TÃ²a nhÃ  Keangnam, Pháº¡m HÃ¹ng;21.0124;105.7844',
      status: 'maintenance',
      totalSlots: 6,
      availableSlots: 0
    }
  ];

  const stations = [];
  for (const stationData of stationsData) {
    const station = await prisma.station.create({
      data: stationData
    });
    stations.push(station);
    console.log(`  âœ“ Created station: ${station.name}`);
  }

  // 3. Táº¡o slots cho má»—i station
  console.log('ğŸ”Œ Táº¡o slots...');
  let batteryIndex = 0;
  
  for (const station of stations) {
    for (let slotNum = 1; slotNum <= station.totalSlots; slotNum++) {
      let slotData = {
        stationId: station.id,
        slotNumber: slotNum,
        status: 'empty',
        isBatteryPresent: false,
        isLocked: true,
        batteryUid: null
      };

      // Assign batteries to some slots
      if (batteryIndex < 15 && slotNum <= 4) {
        const battery = batteries[batteryIndex];
        slotData = {
          ...slotData,
          status: 'occupied',
          isBatteryPresent: true,
          batteryUid: battery.uid
        };
        batteryIndex++;
      }

      await prisma.slot.create({ data: slotData });
    }
    console.log(`  âœ“ Created ${station.totalSlots} slots for ${station.name}`);
  }

  // 4. Táº¡o test customers
  console.log('ğŸ‘¤ Táº¡o customers...');
  const testCustomers = [
    {
      fullName: 'Nguyá»…n VÄƒn A',
      username: 'nguyenvana',
      password: 'password123',
      phone: '0987654321',
      email: 'nguyenvana@example.com',
      balance: 50000,
      currentBatteryUid: 'UID-016'
    },
    {
      fullName: 'Tráº§n Thá»‹ B',
      username: 'tranthib',
      password: 'password123',
      phone: '0976543210',
      email: 'tranthib@example.com',
      balance: 30000,
      currentBatteryUid: 'UID-017'
    },
    {
      fullName: 'LÃª VÄƒn C',
      username: 'levanc',
      password: 'password123',
      phone: '0965432109',
      email: 'levanc@example.com',
      balance: 100000,
      currentBatteryUid: 'UID-018'
    }
  ];

  for (const customerData of testCustomers) {
    const { password, ...rest } = customerData;
    const passwordHash = await bcrypt.hash(password, 10);
    
    const customer = await prisma.customer.create({
      data: {
        ...rest,
        passwordHash
      }
    });
    console.log(`  âœ“ Created customer: ${customer.username}`);
  }

  // 5. Táº¡o sample transactions
  console.log('ğŸ’³ Táº¡o transaction logs...');
  const customer1 = await prisma.customer.findUnique({
    where: { username: 'nguyenvana' }
  });

  await prisma.transactionLog.create({
    data: {
      customerId: customer1.id,
      stationId: stations[0].id,
      requestType: 'swap',
      oldBatteryUid: 'UID-019',
      slotIn: 5,
      newBatteryUid: 'UID-001',
      slotOut: 1,
      cost: 7000,
      status: 'completed',
      completedTime: new Date()
    }
  });
  console.log('  âœ“ Created sample transaction');

  // 6. Táº¡o sample payments
  console.log('ğŸ’° Táº¡o payments...');
  await prisma.payment.create({
    data: {
      customerId: customer1.id,
      orderId: `MOMO_${Date.now()}_${customer1.id}`,
      requestId: `REQ_${Date.now()}_${customer1.id}`,
      amount: 50000,
      status: 'completed',
      paymentMethod: 'momo',
      transactionId: '2891234567',
      momoData: {
        partnerCode: 'MOMO',
        resultCode: 0,
        message: 'Successful'
      },
      completedAt: new Date()
    }
  });
  console.log('  âœ“ Created sample payment');

  // 7. Táº¡o admins
  console.log('ğŸ‘¨â€ğŸ’¼ Táº¡o admins...');
  const adminsData = [
    {
      username: 'admin',
      password: 'admin123',
      fullName: 'Nguyá»…n VÄƒn Admin',
      role: 'superadmin'
    },
    {
      username: 'manager1',
      password: 'manager123',
      fullName: 'Tráº§n Thá»‹ Quáº£n LÃ½',
      role: 'user'
    }
  ];

  for (const adminData of adminsData) {
    const { password, ...rest } = adminData;
    const passwordHash = await bcrypt.hash(password, 10);
    
    const admin = await prisma.admin.create({
      data: {
        ...rest,
        passwordHash
      }
    });
    console.log(`  âœ“ Created admin: ${admin.username} (${admin.role})`);
  }

  // 8. Táº¡o maintenance logs
  console.log('ğŸ”§ Táº¡o maintenance logs...');
  const admin1 = await prisma.admin.findUnique({
    where: { username: 'admin' }
  });

  await prisma.maintenanceLog.create({
    data: {
      stationId: stations[3].id, // Keangnam station
      adminId: admin1.id,
      maintenanceType: 'Scheduled Maintenance',
      description: 'Kiá»ƒm tra Ä‘á»‹nh ká»³ há»‡ thá»‘ng Ä‘iá»‡n vÃ  slot',
      status: 'in_progress',
      scheduledDate: new Date()
    }
  });

  await prisma.maintenanceLog.create({
    data: {
      stationId: stations[0].id, // BÃ¡ch Khoa station
      adminId: admin1.id,
      maintenanceType: 'Battery Replacement',
      description: 'Thay pin há»ng táº¡i slot 3',
      status: 'completed',
      scheduledDate: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000),
      completedDate: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
    }
  });
  console.log('  âœ“ Created maintenance logs');

  // 9. Táº¡o warehouse cho má»—i slot
  console.log('ğŸ“¦ Táº¡o warehouse...');
  const allSlots = await prisma.slot.findMany();
  let warehouseCount = 0;
  
  for (const slot of allSlots) {
    // Chá»‰ táº¡o warehouse cho má»™t sá»‘ slots (vÃ­ dá»¥: slot 6 cá»§a má»—i tráº¡m)
    if (slot.slotNumber === 6) {
      const warehouse = await prisma.warehouse.create({
        data: {
          slotId: slot.id,
          totalCapacity: 10,
          currentCount: 0
        }
      });
      warehouseCount++;
      
      // ThÃªm vÃ i pin vÃ o warehouse
      const warehouseBatteries = ['UID-020', 'UID-019', 'UID-018'];
      for (const batteryUid of warehouseBatteries) {
        await prisma.warehouseBattery.create({
          data: {
            warehouseId: warehouse.id,
            batteryUid: batteryUid
          }
        });
      }
      
      // Update current count
      await prisma.warehouse.update({
        where: { id: warehouse.id },
        data: { currentCount: warehouseBatteries.length }
      });
    }
  }
  console.log(`  âœ“ Created ${warehouseCount} warehouses with batteries`);

  console.log('âœ… Seeding completed!');
}

main()
  .catch((e) => {
    console.error('âŒ Seeding error:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
```

3.3.5.2. Cháº¡y Seed Script

```bash
# Development
node seed-heroku.js

# Production (Heroku)
heroku run node seed-heroku.js --app your-app-name
```

Output:
```
ğŸŒ± Báº¯t Ä‘áº§u seeding database...
ğŸ“¦ Táº¡o batteries...
  âœ“ Created battery: UID-001
  âœ“ Created battery: UID-002
  ... (20 batteries)
ğŸ¢ Táº¡o stations...
  âœ“ Created station: Tráº¡m Äáº¡i há»c BÃ¡ch Khoa
  âœ“ Created station: Tráº¡m PTIT
  ... (4 stations)
ğŸ”Œ Táº¡o slots...
  âœ“ Created 6 slots for Tráº¡m Äáº¡i há»c BÃ¡ch Khoa
  ... (24 slots total)
ğŸ‘¤ Táº¡o customers...
  âœ“ Created customer: nguyenvana
  âœ“ Created customer: tranthib
  âœ“ Created customer: levanc
ğŸ’³ Táº¡o transaction logs...
  âœ“ Created sample transaction
ğŸ’° Táº¡o payments...
  âœ“ Created sample payment
ğŸ‘¨â€ğŸ’¼ Táº¡o admins...
  âœ“ Created admin: admin (superadmin)
  âœ“ Created admin: manager1 (user)
ğŸ”§ Táº¡o maintenance logs...
  âœ“ Created maintenance logs
ğŸ“¦ Táº¡o warehouse...
  âœ“ Created 4 warehouses with batteries
âœ… Seeding completed!
```

3.3.6. DEPLOY LÃŠN PRODUCTION (HEROKU)

3.3.6.1. Setup Heroku Postgres

```bash
# 1. Login to Heroku
heroku login

# 2. Create app
heroku create ev-swap-backend

# 3. Add Postgres addon
heroku addons:create heroku-postgresql:mini

# 4. Get database URL
heroku config:get DATABASE_URL

# Output:
# postgres://u123abc:p456def@ec2-52-1-2-3.compute-1.amazonaws.com:5432/d789ghi
```

3.3.6.2. Cáº¥u hÃ¬nh Environment Variables

```bash
# Set environment variables
heroku config:set JWT_SECRET="your-production-secret"
heroku config:set NODE_ENV="production"

# Verify
heroku config
```

3.3.6.3. Deploy Database Schema

Trong package.json, thÃªm build script:
```json
{
  "scripts": {
    "build": "npx prisma generate",
    "start": "node src/index.js",
    "heroku-postbuild": "npx prisma migrate deploy"
  }
}
```

Deploy:
```bash
# 1. Push code to Heroku
git push heroku main

# 2. Prisma migrations sáº½ tá»± Ä‘á»™ng cháº¡y sau khi build
# (via heroku-postbuild script)

# 3. Verify migrations
heroku run npx prisma migrate status

# Output:
# Status
# 1 migration found in prisma/migrations
# 
# Following migration have been applied:
# 
# migrations/
#   â””â”€ 20241201_init

# 4. Seed production data
heroku run node seed-heroku.js
```

3.3.6.4. Káº¿t ná»‘i Database tá»« Local

```bash
# Get connection string
heroku config:get DATABASE_URL --app ev-swap-backend

# Use with Prisma Studio
DATABASE_URL="<heroku-postgres-url>" npx prisma studio

# Or use psql
heroku pg:psql --app ev-swap-backend
```

Prisma Studio on production data:
```bash
# Cáº£nh bÃ¡o: Cáº©n tháº­n khi edit production data!
DATABASE_URL=$(heroku config:get DATABASE_URL) npx prisma studio
```

3.3.7. PRISMA STUDIO - GUI MANAGEMENT

3.3.7.1. Khá»Ÿi Ä‘á»™ng Prisma Studio

```bash
npx prisma studio
```

Browser sáº½ má»Ÿ táº¡i http://localhost:5555

Features:
- View all tables and records
- Filter, sort, paginate data
- Create, edit, delete records
- See relations (click on foreign keys)
- Export data to JSON

3.3.7.2. CÃ¡c thao tÃ¡c phá»• biáº¿n

a) View customers vá»›i current battery:
```
1. Click "Customer" table
2. Check "Include Relations"
3. Expand "currentBattery" to see battery details
```

b) Filter stations by status:
```
1. Click "Station" table
2. Click "Add filter"
3. Select "status" = "active"
4. Apply
```

c) Edit record:
```
1. Click on any cell
2. Edit value
3. Click "Save 1 change" button
```

3.3.8. CASE STUDIES - THAY Äá»”I SCHEMA TRONG DEVELOPMENT

3.3.8.1. Case Study 1: ThÃªm trÆ°á»ng email vÃ o Customer

Requirement: ThÃªm email Ä‘á»ƒ gá»­i notification

Step 1: Update schema.prisma
```prisma
model Customer {
  // ... existing fields
  email String? @unique @db.VarChar(100)
}
```

Step 2: Create migration
```bash
npx prisma migrate dev --name add_email_to_customer
```

Step 3: Update seed script Ä‘á»ƒ bao gá»“m email
```javascript
const customer = await prisma.customer.create({
  data: {
    fullName: "Test",
    username: "test",
    passwordHash: "...",
    email: "test@example.com" // New field
  }
});
```

Step 4: Update controllers náº¿u cáº§n
```javascript
// auth.controller.js - register
const { email } = req.body;
const newCustomer = await prisma.customer.create({
  data: {
    // ...
    email // Include email in registration
  }
});
```

3.3.8.2. Case Study 2: Thay Ä‘á»•i format trÆ°á»ng location

Requirement: Äá»•i tá»« object {lat, lng} sang string "address;lat;lng"

Step 1: Identify current format
```javascript
// Old format (hardcoded in frontend):
const station = {
  location: { latitude: 21.0063, longitude: 105.8433 }
};
```

Step 2: Update schema (no change needed, already VARCHAR(255))
```prisma
model Station {
  location String? @db.VarChar(255)
}
```

Step 3: Update seed data
```javascript
// Before:
location: "HÃ  Ná»™i"

// After:
location: "Há»c viá»‡n PTIT;21.0063;105.8433"
```

Step 4: Create data migration (not schema migration)
```javascript
// migrate-location-format.js
const prisma = require('./src/config/database');

async function migrate() {
  const stations = await prisma.station.findMany();
  
  const updates = stations.map(station => {
    // Parse old format and convert to new
    const newLocation = `${station.name};${station.latitude};${station.longitude}`;
    
    return prisma.station.update({
      where: { id: station.id },
      data: { location: newLocation }
    });
  });

  await Promise.all(updates);
}

migrate();
```

Step 5: Update frontend parsing
```typescript
// MapScreen.tsx
const parseLocation = (locationString: string) => {
  const [address, lat, lng] = locationString.split(';');
  return {
    address,
    latitude: parseFloat(lat),
    longitude: parseFloat(lng)
  };
};
```

3.3.9. BACKUP VÃ€ RESTORE

3.3.9.1. Backup Database (Heroku)

```bash
# Create backup
heroku pg:backups:capture --app ev-swap-backend

# Download backup
heroku pg:backups:download --app ev-swap-backend

# Output: latest.dump file
```

Restore to local:
```bash
# Restore from dump file
pg_restore --verbose --clean --no-acl --no-owner \
  -h localhost -U postgres -d ev_swap_dev latest.dump
```

3.3.9.2. Export data vá»›i Prisma

```javascript
// export-data.js
const prisma = require('./src/config/database');
const fs = require('fs');

async function exportData() {
  const customers = await prisma.customer.findMany({
    include: {
      currentBattery: true,
      transactionLogs: true
    }
  });

  fs.writeFileSync(
    'customers-backup.json',
    JSON.stringify(customers, null, 2)
  );
  
  console.log('Export completed!');
}

exportData();
```

3.3.10. MONITORING VÃ€ PERFORMANCE

3.3.10.1. Enable Query Logging

```javascript
const prisma = new PrismaClient({
  log: [
    { level: 'query', emit: 'event' },
    { level: 'error', emit: 'stdout' },
    { level: 'warn', emit: 'stdout' }
  ]
});

prisma.$on('query', (e) => {
  console.log('Query: ' + e.query);
  console.log('Duration: ' + e.duration + 'ms');
});
```

3.3.10.2. Connection Pooling

Heroku Postgres limits:
- Mini plan: 20 connections
- Basic plan: 60 connections

Prisma connection pool (default):
```javascript
const prisma = new PrismaClient({
  datasources: {
    db: {
      url: process.env.DATABASE_URL,
    },
  },
  // Connection pool settings (implicit)
  // connection_limit=10 (default)
});
```

3.3.10.3. Database Indexes

Prisma tá»± Ä‘á»™ng táº¡o indexes cho:
- Primary keys (@id)
- Unique constraints (@unique)
- Foreign keys

ThÃªm custom index:
```prisma
model TransactionLog {
  id         Int @id
  customerId Int
  
  @@index([customerId, transactionTime])
  // Optimize: SELECT * FROM transaction_logs 
  //           WHERE customer_id = ? ORDER BY transaction_time
}
```

Apply index:
```bash
npx prisma migrate dev --name add_transaction_index
```

Generated SQL:
```sql
CREATE INDEX "transaction_logs_customer_id_transaction_time_idx" 
  ON "transaction_logs"("customer_id", "transaction_time");
```

================================================================================
Káº¾T LUáº¬N PHáº¦N 3.3

QuÃ¡ trÃ¬nh phÃ¡t triá»ƒn cÆ¡ sá»Ÿ dá»¯ liá»‡u cá»§a há»‡ thá»‘ng EV-Swap sá»­ dá»¥ng Prisma ORM 
Ä‘Ã£ triá»ƒn khai Ä‘áº§y Ä‘á»§ 12 báº£ng nghiá»‡p vá»¥, phá»¥c vá»¥ cáº£ Mobile App vÃ  Admin Web:

**Mobile App (8 báº£ng):**
1. customers - Quáº£n lÃ½ khÃ¡ch hÃ ng
2. batteries - Quáº£n lÃ½ pin
3. stations - Quáº£n lÃ½ tráº¡m Ä‘á»•i pin
4. slots - Quáº£n lÃ½ Ã´ cáº¯m pin
5. transaction_logs - Lá»‹ch sá»­ giao dá»‹ch Ä‘á»•i pin
6. payments - Thanh toÃ¡n qua MoMo
7. reservations - Äáº·t chá»— trÆ°á»›c
8. feedbacks - Pháº£n há»“i khÃ¡ch hÃ ng

**Admin Web (4 báº£ng bá»• sung):**
9. admins - Quáº£n trá»‹ viÃªn há»‡ thá»‘ng
10. maintenance_logs - Lá»‹ch sá»­ báº£o trÃ¬ tráº¡m
11. warehouse - Kho lÆ°u trá»¯ pin
12. warehouse_batteries - Pin trong kho

**ThÃ nh tá»±u Ä‘áº¡t Ä‘Æ°á»£c:**

1. **Type Safety**: Prisma Client tá»± Ä‘á»™ng generate types tá»« schema, giáº£m bugs
2. **Migration Management**: Schema changes Ä‘Æ°á»£c version control qua migrations
3. **Developer Experience**: Prisma Studio GUI giÃºp debug vÃ  test data dá»… dÃ ng
4. **Production Ready**: Deploy lÃªn Heroku Postgres vá»›i migrations tá»± Ä‘á»™ng
5. **Data Seeding**: Seed scripts táº¡o test data Ä‘áº§y Ä‘á»§ cho cáº£ 12 báº£ng
6. **Maintainability**: Single source of truth (schema.prisma) dá»… Ä‘á»c vÃ  maintain
7. **Performance**: Auto-generated indexes vÃ  connection pooling
8. **Dual Backend Support**: Schema tÆ°Æ¡ng thÃ­ch vá»›i cáº£ Prisma (Mobile) vÃ  pg driver (Admin)

**CÃ¡c best practices Ä‘Ã£ Ã¡p dá»¥ng:**
- LuÃ´n test migrations trÃªn local trÆ°á»›c khi deploy
- Sá»­ dá»¥ng transactions cho cÃ¡c operations phá»©c táº¡p (Ä‘á»•i pin, thanh toÃ¡n)
- Enable query logging Ä‘á»ƒ monitor performance
- Backup Ä‘á»‹nh ká»³ trÆ°á»›c khi thá»±c hiá»‡n schema changes lá»›n
- Document format cá»§a cÃ¡c trÆ°á»ng Ä‘áº·c biá»‡t (location: "address;lat;lng", UID format)
- Foreign key constraints Ä‘áº£m báº£o referential integrity
- Cascade delete cho quan há»‡ parent-child (Station â†’ Slots â†’ Warehouse)
- Set NULL cho quan há»‡ optional (Customer â†’ currentBattery)

**Káº¿t quáº£:**
Má»™t database schema vá»¯ng cháº¯c vá»›i 12 báº£ng Ä‘Æ°á»£c chuáº©n hÃ³a tá»‘t, phá»¥c vá»¥ Ä‘áº§y Ä‘á»§ 
nhu cáº§u cá»§a cáº£ hai á»©ng dá»¥ng (Mobile App cho khÃ¡ch hÃ ng vÃ  Admin Web cho quáº£n trá»‹ 
viÃªn), dá»… báº£o trÃ¬ vÃ  sáºµn sÃ ng scale khi há»‡ thá»‘ng phÃ¡t triá»ƒn.
================================================================================
